"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))(function(n,a){function i(e){try{u(o.next(e))}catch(e){a(e)}}function s(e){try{u(o.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(i,s)}u((o=o.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.makeComputerMove=void 0;const obray_1=require("../../lib/obray"),max_n_is_1=require("./max-n-is"),player_score_1=require("./player-score"),worker_1=require("./worker"),game_state_1=require("../models/game-state");function makeComputerMove(e){return __awaiter(this,void 0,void 0,function*(){return computerMoveParallel(e,1e3,3)})}exports.makeComputerMove=makeComputerMove;const TIMEOUT=5e3;function computerMoveParallel(e,t,r){return __awaiter(this,void 0,void 0,function*(){return new Promise((o,n)=>{const a=setTimeout(()=>n("calculation took too long"),TIMEOUT),i=e.player,s=game_state_1.getNextGameStates(e),u=Math.min(r,s.length),c=makeWorkerInputs(i,s,u);let l=s.map(e=>max_n_is_1.maxNIS(e,0));const{startWorkers:m,destroyWorkers:_}=initWorkers(u,c,({index:e,score:t})=>{l[e]=t});m(),setTimeout(()=>{const e=player_score_1.findMaxScoreIndex(l,i),t=s[e];o(t),_(),clearTimeout(a)},t)})})}function initWorkers(e,t,r){let o=createWorkers(e,r);return{startWorkers:()=>{for(let e=0,r=o.length;e<r;e++)o[e].postMessage(t[e])},destroyWorkers:()=>{for(let e=0,t=o.length;e<t;e++)o[e].terminate()}}}function createWorkers(e,t){let r=[];for(let o=0;o<e;o++)r[o]=worker_1.initWorker(t);return r}function makeWorkerInputs(e,t,r){const o=t.map((e,t)=>({index:t,gameState:e}));return obray_1.splitEqual(o,r).map(t=>({player:e,gameStates:t}))}